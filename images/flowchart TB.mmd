%% Fichier corrigÃ© pour compatibilitÃ© Mermaid (syntaxe, <br>, labels, etc.)
flowchart TB

%% ========== ZONE UTILISATEURS ==========
subgraph ZU[Zone Utilisateurs / Frontale]
    U[ğŸ‘¤ Utilisateur humain<br>(navigateur web)]
    OWUI[ğŸ§  OpenWebUI<br>(frontend + backend)]
end

%% ========== AUTHENTIFICATION LOCALE ==========
subgraph AUTH[Zone SSO locale]
    KC[ğŸ” Keycloak local<br>Realm 'intra'<br>â€¢ gÃ¨re login humain<br>â€¢ gÃ¨re client_credentials service<br>â€¢ dÃ©livre tokens OIDC/JWT]
end

%% ========== ACCÃˆS AU CACHE S3 LOCAL ==========
subgraph CACHE[Zone Cache S3 locale (LAN/cluster)]
    EPUSER[ğŸŒ Endpoint USER<br>(Reverse proxy #1)<br>â€¢ exposÃ© aux navigateurs<br>â€¢ OIDC interactif / URL prÃ©-signÃ©e<br>â€¢ rate limit fort<br>â€¢ pas de delete dangereux]
    EPSVC[ğŸ”§ Endpoint SERVICE<br>(Reverse proxy #2)<br>â€¢ rÃ©seau interne only<br>â€¢ mTLS / client_credentials<br>â€¢ dÃ©bit Ã©levÃ©<br>â€¢ pas d'accÃ¨s direct depuis l'utilisateur]
    MINIO[ğŸ“¦ MinIO Gateway Cache<br>Mode gateway s3<br>â€¢ cache disque local<br>â€¢ policies IAM locales<br>â€¢ sÃ©pare droits 'user' vs 'service']
    IAMLOCAL[(ğŸ“œ Policies IAM locales MinIO<br>â€¢ s3-user-role = accÃ¨s restreint Ã  /uploads/userX/*<br>â€¢ s3-service-role = accÃ¨s technique Ã©tendu<br>â€¢ pas de privilÃ¨ges admin)]
end

%% ========== ZONE DE PROTECTION DU STOCKAGE ==========
subgraph PROTECT[Zone de protection distante]
    RP[ğŸ›¡ Reverse Proxy SÃ©curisÃ© (mTLS+RL)<br>â€¢ mTLS obligatoire venant du cache<br>â€¢ rate limiting/burst control<br>â€¢ circuit breaker<br>â€¢ journaux sÃ©curitÃ©]
    FW[ğŸš§ Firewall / ACL rÃ©seau<br>â€¢ n'autorise QUE RP Ã  parler au stockage distant<br>â€¢ coupe toute IP non approuvÃ©e]
end

%% ========== STOCKAGE DE RÃ‰FÃ‰RENCE ==========
subgraph BACKER[Zone Stockage distant (back-end 3)]
    S3[(ğŸ—„ S3 Distant 'backer-data'<br>â€¢ cluster distribuÃ©<br>â€¢ erasure coding<br>â€¢ haute dispo)]
    IAMB[ğŸ”’ IAM backer<br>Compte 'gateway-cache'<br>â€¢ accÃ¨s UNIQUEMENT bucket backer-data<br>â€¢ pas de delete global<br>â€¢ pas d'admin cluster]
    KMS[ğŸ”‘ KMS / Vault interne<br>â€¢ clÃ©s SSE-KMS<br>â€¢ chiffrement des objets au repos]
end

%% ========== OBSERVABILITÃ‰ ==========
subgraph OBS[Supervision / SOC]
    SIEM[ğŸ“ˆ SIEM / Grafana / Loki<br>â€¢ logs EPUSER/EPSVC<br>â€¢ logs RP/FW<br>â€¢ logs MinIO<br>â€¢ audit IAM backer]
end

%% ========== LIENS PRINCIPAUX ==========

U -->|"Upload fichier / download<br>(navigateur)"| EPUSER
OWUI -->|"RequÃªtes techniques<br>(embeddings, logs modÃ¨les...)"| EPSVC

U -->|"Login OIDC / session"| KC
OWUI -->|"client_credentials OIDC<br>(service account)"| KC

EPUSER -->|"Authorization: Bearer <token user><br>ou URL prÃ©-signÃ©e courte durÃ©e"| MINIO
EPSVC -->|"Authorization: Bearer <token service><br>(mTLS interne possible)"| MINIO

MINIO -->|"Lecture/Ã©criture locale si en cache<br>(policy IAM locale)"| MINIO

MINIO -->|"Objet manquant / refresh TTL<br>â†’ Aller chercher dans le back-end"| RP
RP -->|"Flux filtrÃ©, mTLS, rate limit"| FW
FW -->|"Connexion autorisÃ©e uniquement<br>depuis RP (whitelist IP + port)"| S3
S3 -->|"DonnÃ©es du bucket 'backer-data'"| MINIO

S3 -->|"Chiffrement SSE-KMS"| KMS

%% Logs
EPUSER -->|"logs accÃ¨s user"| SIEM
EPSVC -->|"logs accÃ¨s service"| SIEM
MINIO -->|"audit interne MinIO : qui a lu/Ã©crit quoi"| SIEM
RP -->|"logs taux requÃªtes / anomalies rÃ©seau"| SIEM
FW -->|"logs filtrage IP"| SIEM
S3 -->|"audit IAM backer<br>(utilisation 'gateway-cache')"| SIEM