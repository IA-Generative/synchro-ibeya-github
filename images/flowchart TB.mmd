%% Fichier corrigé pour compatibilité Mermaid (syntaxe, <br>, labels, etc.)
flowchart TB

%% ========== ZONE UTILISATEURS ==========
subgraph ZU["Zone Utilisateurs / Frontale"]
    U["Utilisateur humain\n(navigateur web)"]
    OWUI["OpenWebUI\n(frontend + backend)"]
end

%% ========== AUTHENTIFICATION LOCALE ==========
subgraph AUTH["Zone SSO locale"]
    KC["Keycloak local\nRealm 'intra'\n• gère login humain\n• gère client_credentials service\n• délivre tokens OIDC/JWT"]
end

%% ========== ACCÈS AU CACHE S3 LOCAL ==========
subgraph CACHE["Zone Cache S3 locale (LAN/cluster)"]
    EPUSER["Endpoint USER\n(Reverse proxy #1)\n• exposé aux navigateurs\n• OIDC interactif / URL pré-signée\n• rate limit fort\n• pas de delete dangereux"]
    EPSVC["Endpoint SERVICE\n(Reverse proxy #2)\n• réseau interne only\n• mTLS / client_credentials\n• débit élevé\n• pas d'accès direct depuis l'utilisateur"]
    MINIO["MinIO Gateway Cache\nMode gateway s3\n• cache disque local\n• policies IAM locales\n• sépare droits 'user' vs 'service'"]
    IAMLOCAL[("Policies IAM locales MinIO\n• s3-user-role = accès restreint à /uploads/userX/*\n• s3-service-role = accès technique étendu\n• pas de privilèges admin")]
end

%% ========== ZONE DE PROTECTION DU STOCKAGE ==========
subgraph PROTECT["Zone de protection distante"]
    RP["Reverse Proxy Sécurisé (mTLS+RL)\n• mTLS obligatoire venant du cache\n• rate limiting/burst control\n• circuit breaker\n• journaux sécurité"]
    FW["Firewall / ACL réseau\n• n'autorise QUE RP à parler au stockage distant\n• coupe toute IP non approuvée"]
end

%% ========== STOCKAGE DE RÉFÉRENCE ==========
subgraph BACKER["Zone Stockage distant (back-end 3)"]
    S3[("S3 Distant 'backer-data'\n• cluster distribué\n• erasure coding\n• haute dispo")]
    IAMB["IAM backer\nCompte 'gateway-cache'\n• accès UNIQUEMENT bucket backer-data\n• pas de delete global\n• pas d'admin cluster"]
    KMS["KMS / Vault interne\n• clés SSE-KMS\n• chiffrement des objets au repos"]
end

%% ========== OBSERVABILITÉ ==========
subgraph OBS["Supervision / SOC"]
    SIEM["SIEM / Grafana / Loki\n• logs EPUSER/EPSVC\n• logs RP/FW\n• logs MinIO\n• audit IAM backer"]
end

%% ========== LIENS PRINCIPAUX ==========

U -->|"Upload fichier / download\n(navigateur)"| EPUSER
OWUI -->|"Requêtes techniques\n(embeddings, logs modèles...)"| EPSVC

U -->|"Login OIDC / session"| KC
OWUI -->|"client_credentials OIDC\n(service account)"| KC

EPUSER -->|"Authorization: Bearer <token user>\nou URL pré-signée courte durée"| MINIO
EPSVC -->|"Authorization: Bearer <token service>\n(mTLS interne possible)"| MINIO

MINIO -->|"Lecture/écriture locale si en cache\n(policy IAM locale)"| MINIO

MINIO -->|"Objet manquant / refresh TTL\n→ Aller chercher dans le back-end"| RP
RP -->|"Flux filtré, mTLS, rate limit"| FW
FW -->|"Connexion autorisée uniquement\ndepuis RP (whitelist IP + port)"| S3
S3 -->|"Données du bucket 'backer-data'"| MINIO

S3 -->|"Chiffrement SSE-KMS"| KMS

%% Logs
EPUSER -->|"logs accès user"| SIEM
EPSVC -->|"logs accès service"| SIEM
MINIO -->|"audit interne MinIO : qui a lu/écrit quoi"| SIEM
RP -->|"logs taux requêtes / anomalies réseau"| SIEM
FW -->|"logs filtrage IP"| SIEM
S3 -->|"audit IAM backer\n(utilisation 'gateway-cache')"| SIEM